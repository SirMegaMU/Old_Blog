---
layout: post
title: PN532
date: 2022-07-07
tags: IoT
mathjax: true
---

### 信息帧

#### 普通帧的结构

![image](../images/posts/2022-07-07/1.png)

> ACK，应答，六字节
>
> `00 00 FF 00 FF 00`，仅在应答指令时出现

> PREAMBLE，帧头，一字节
>
> `00`

> START CODE，开始码，两字节
>
> `00 FF`

> LEN，数据长度，一字节

> LCS，长度检验，一字节
>
> LEN的补码的低位

> TFI，数据方向，一字节
>
> `D4`表示数据流向PN532
>
> `D5`表示数据流向控制器

> DATA，数据，LEN-1字节
>
> PD0为控制字符，其余为普通数据

> DCS，数据检验，一字节
>
> TFI+PD0+···+PDn+DCS的补码

> POSTAMBLE，帧尾，一字节
>
> `00`

#### 扩展帧

![image](../images/posts/2022-07-07/2.png)

> LEN 和LCS都填充为`FF`

> LEN，扩展长度，两字节
>
> 实际长度为LEN$_L$×256+LEN$_M$ 

> LCS，长度检验，一字节
>
> LEN$_M$+LEN$_L$的补码的低位

### 命令

#### 唤醒

> 发送 `55 55 00 00 00 00 00 00 00 00 00 00 00 00 00 00 FF 03 FD D4 14 01 17 00`
>
> 返回 `00 00 FF 00 FF 00 00 00 FF 02 FE D5 15 16 00`

#### 获取卡UID（4字节）

发送`00 00 FF 04 FC D4 4A nn 00 DCS 00`

> `4A`：命令
>
> `nn`：卡的数量，最多为2
>
> `00`：波特率

返回`00 00 FF 0C F4 D5 4B 01 01 00 04 08 nn UID DCS 00`

> `4B`：响应命令
>
> `01`：目标卡
>
> `01`：目标卡数量
>
> `00 04`：鬼知道干什么的
>
> `08`：卡容量
>
> `nn`：UID字节数
>
> `UID`：UID的值

#### 密钥验证

发送`00 00 FF 0F F1 D4 40 nn 60 aa PASSWORD UID DCS 00`

> `40`：命令
>
> `nn`：卡号
>
> `60`：密钥验证命令
>
> `aa`：块号
>
> `PASSWORD`：密钥

返回`00 00 FF 00 FF 00 00 00 FF 03 FD D5 41 00 EA 00 `

> `41 00`：正确状态
